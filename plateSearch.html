<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plate Search - Guests Staying Today</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 0;
    }

    main {
      max-width: 950px;
      margin: 1rem auto;
      background: white;
      padding: 1.2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    h2 { margin-top: 0; }

    /* üîô Back Button */
    .back-btn {
      background-color: #0078d7;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      margin-bottom: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease;
    }

    .back-btn:hover { background-color: #005fa3; }

    /* üîç Search Bar */
.search-container {
  margin: 1rem 0;
  width: 100%;
  box-sizing: border-box;
}

#searchInput {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1rem;
  transition: 0.2s;
  box-sizing: border-box; /* ‚úÖ Prevent overflow */
  display: block;
}


    #searchInput:focus {
      border-color: #0078d7;
      outline: none;
      box-shadow: 0 0 3px rgba(0,120,215,0.3);
    }

    /* üßæ Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: left;
      vertical-align: middle;
    }

    th { background: #f3f4f6; }

    button.action-btn {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      margin: 3px 0;
      cursor: pointer;
      color: white;
      font-size: 0.85rem;
      transition: 0.2s ease;
      width: 100%;
    }

    .call-btn { background-color: #34a853; }
    .call-btn:hover { background-color: #2e8b47; }

    .wa-btn { background-color: #25D366; }
    .wa-btn:hover { background-color: #1da851; }

/* Loading Popup Styles */
.loading-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(8px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.loading-popup.show {
  display: flex;
  opacity: 1;
}

.loading-content {
  background: white;
  padding: 2.5rem;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  text-align: center;
  max-width: 320px;
  width: 90%;
  animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.progress-circle {
  position: relative;
  width: 100px;
  height: 100px;
  margin: 0 auto 1.5rem;
}

.circle-background {
  position: absolute;
  width: 100%;
  height: 100%;
  border: 3px solid #e2e8f0;
  border-radius: 50%;
}

.circle-progress {
  position: absolute;
  width: 100%;
  height: 100%;
  border: 3px solid transparent;
  border-top: 3px solid #0ea5e9;
  border-radius: 50%;
  animation: spin 1.2s linear infinite;
}

.circle-inner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.loading-text {
  font-size: 0.9rem;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 0.25rem;
}

.loading-dots {
  display: flex;
  justify-content: center;
  gap: 3px;
}

.loading-dots span {
  width: 4px;
  height: 4px;
  background: #64748b;
  border-radius: 50%;
  animation: bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes bounce {
  0%, 80%, 100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}

.loading-content p {
  color: #64748b;
  font-size: 0.9rem;
  margin: 0;
  line-height: 1.5;
}

    /* üì± Responsive Design */
    @media (max-width: 768px) {
      main {
        margin: 0.5rem;
        padding: 1rem;
      }

      h2 {
        font-size: 1.25rem;
      }

      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        background: #eef2f7;
        margin-bottom: 1rem;
        border-radius: 10px;
        padding: 0.8rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      }

      td {
        border: none;
        padding: 6px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #333;
      }

      td:last-child {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      button.action-btn {
        font-size: 0.9rem;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <main>
    <button class="back-btn" onclick="window.history.back()">‚¨ÖÔ∏è Back</button>

    <h2 id="pageTitle">Guests Staying Today</h2>
    <p>This shows all vehicles with bookings overlapping today‚Äôs date.</p>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="üîç Search plate number...">
    </div>

    <table id="plateTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>Book Id</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Plate Number</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="plateBody">
        <tr><td colspan="7">Loading...</td></tr>
      </tbody>
    </table>
  </main>

<div id="loadingPopup" class="loading-popup">
  <div class="loading-content">
    <div class="progress-circle">
      <div class="circle-background"></div>
      <div class="circle-progress"></div>
      <div class="circle-inner">
        <div class="loading-text">Loading</div>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
    <p>Please wait while we process your data...</p>
  </div>
</div>

<script>
  const DEPLOYMENT_ID = "AKfycbwsPIi_Zf7UtwTQJ8BPiLmNR87VxecATUOItw68loKglD60QRcRzeQoqIzyynvTXolipA";
  const API_URL = `https://script.google.com/macros/s/${DEPLOYMENT_ID}/exec`;
  const today = new Date();
  const todayStr = today.toLocaleDateString("en-GB");
  let stayingData = [];

// Loading functions
function showLoading() {
  const loadingPopup = document.getElementById('loadingPopup');
  loadingPopup.classList.add('show');
}

function hideLoading() {
  const loadingPopup = document.getElementById('loadingPopup');
  loadingPopup.classList.remove('show');
}

  document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("pageTitle").textContent = `Guests Staying Today ‚Äì ${todayStr}`;
  showLoading(); // Add this line
  setTimeout(() => {
    fetchStayingGuests();
  }, 500);

    document.getElementById("searchInput").addEventListener("input", (e) => {
      const searchTerm = e.target.value.toLowerCase();
      renderTable(
        stayingData.filter(b =>
          Object.values(b).some(v =>
            String(v || "").toLowerCase().includes(searchTerm)
          )
        )
      );
    });
  });

  async function fetchStayingGuests() {
  showLoading();
    const tbody = document.getElementById("plateBody");
    tbody.innerHTML = "";

    try {
      const res = await fetch(API_URL);
      const data = await res.json();

      if (!data.bookings || !Array.isArray(data.bookings)) {
        throw new Error("No 'bookings' array in response.");
      }

      stayingData = data.bookings.filter(b => {
        const checkin = parseSheetDate(b.checkin);
        const checkout = parseSheetDate(b.checkout);
        return checkin && checkout && checkin <= today && today <= checkout;
      });

      renderTable(stayingData);
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="7">‚ùå Error loading data.</td></tr>`;
    } finally {
       hideLoading();
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById("plateBody");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="7">No guests currently staying (${todayStr}).</td></tr>`;
      return;
    }

    data.forEach((b, i) => {
      const tr = document.createElement("tr");
      const checkinDate = formatDisplayDate(b.checkin);
      const checkoutDate = formatDisplayDate(b.checkout);
      const phone = String(b.phone || '').trim();
      const cleanPhone = phone.replace(/\s+/g, '');
      const callLink = `tel:${cleanPhone}`;
      const waLink = `https://wa.me/${formatWhatsapp(cleanPhone)}`;

      // ‚úÖ Format plate text nicely with line breaks
      const formattedRemark = formatPlateRemark(b.remark || '');

      tr.innerHTML = `
        <td data-label="No.">${i + 1}</td>
        <td data-label="Name">${b.name || '-'}</td>
        <td data-label="Book Id">${b.bookId || '-'}</td>
        <td data-label="Check-In">${checkinDate}</td>
        <td data-label="Check-Out">${checkoutDate}</td>
        <td data-label="Plate" style="white-space: pre-line;">${formattedRemark}</td>
        <td data-label="Action">
          <button class="action-btn call-btn" onclick="window.open('${callLink}', '_self')">üìû Call</button>
          <button class="action-btn wa-btn" onclick="window.open('${waLink}', '_blank')">üí¨ WhatsApp</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‚úÖ Converts "CAR: ...MOTORCYCLE: ..." into line breaks
  function formatPlateRemark(remark) {
    if (!remark) return '‚Äî';

    let formatted = remark
      .replace(/(CAR:)/gi, '\n$1')
      .replace(/(MOTORCYCLE:)/gi, '\n$1')
      .trim();

    // Remove first newline if any
    if (formatted.startsWith('\n')) formatted = formatted.substring(1);

    return formatted;
  }

  function parseSheetDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d)) return null;
    return d;
  }

  function formatDisplayDate(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    if (isNaN(d)) return "-";
    return d.toLocaleDateString("en-GB");
  }

  function formatWhatsapp(phone) {
    if (!phone) return "";
    let p = phone.replace(/\D/g, "");
    if (p.startsWith("0")) p = "6" + p;
    if (!p.startsWith("6")) p = "6" + p;
    return p;
  }
</script>
</body>
</html>

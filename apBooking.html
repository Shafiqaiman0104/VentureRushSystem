<!-- full updated version with generateToyyibpayLink and delayed reload -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Booking</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #eef2f7; }
    header {
      background: #ffffff;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      flex-wrap: wrap;
    }
    .logo { font-weight: bold; }
    .menu-toggle {
      display: none;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
    }
    nav { display: flex; gap: 1rem; align-items: center; }
    .tab {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.95rem;
    }


.dropdown-btn {
    margin: 0 4px;
    padding: 8px 12px;
    background-color: #f3f4f6;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    width: 150px;
  }
  .dropdown {
    position: relative;
  }
 .dropdown-content {
    display: none;
    position: absolute;
    top: 110%;
    left: 0;
    background-color: white;
    min-width: 100%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 999;
    flex-direction: column;
  }
  .dropdown-content button {
    padding: 10px;
    width: 100%;
    text-align: left;
    background-color: #f3f4f6;
    border: none;
    border-top: 1px solid #ccc;
    border-radius: 0px; /* ‚Üê square buttons */
    white-space: nowrap;      
  }
  .dropdown-content button:hover {
    background-color: white; 
    color: #000; /* optional: make text darker for visibility */
  }
 .dropdown:hover .dropdown-content {
    display: flex;
  }


    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .mobile-menu {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      width: 100%;
    }
    .welcome-mobile {
      display: none;
      font-size: 0.8rem;
      color: #334155;
      margin-left: auto;
      margin-right: 0.5rem;
    }
    main { padding: 1rem; max-width: 800px; margin: auto; }
    .card {
      background: white;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .form-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .form-group label {
      flex: 1;
      min-width: 45%;
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
    }
    .form-group input {
      margin-top: 0.3rem;
      padding: 0.5rem;
      border: 1px solid #cbd5e1;
      border-radius: 5px;
      font-size: 1rem;
    }
    .btn-main {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background: #0d9488;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      margin-top: 0.5rem;
      transition: background 0.2s;
    }
    .btn-main:hover { background: #0f766e; }
    #loadingOverlay {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .loading-popup {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.2rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
        .bell {
      position: relative; font-size: 22px; cursor: pointer;
    }
    .badge {
      position: absolute; top: -8px; right: -10px;
      background: red; color: white; border-radius: 50%;
      padding: 2px 6px; font-size: 12px;
    }
    .dropdownNoti {
      display: none;
      position: absolute; left: 20px; top: 50px;
      background: white; width: 320px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 8px; 
      overflow-y: auto;       /* enable vertical scroll */
      max-height: 60vh;       /* limit height to 60% of screen */
      z-index: 999;
    }
    .dropdownNoti.active { display: block; }
    .notification {
      padding: 10px; border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .notification strong { color: #0073e6; display: block; margin-bottom: 5px; }
    .notification button {
      margin-top: 6px; padding: 5px 10px;
      background: #0073e6; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 12px;
    }
    .notification button:hover { background: #005bb5; }

/* Vehicle Calculation Styles */
#vehicleCalculationCard {
  background: #f8fafc;
  border-left: 4px solid #0d9488;
}

#vehicleCalculationResult {
  background: white;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  border: 1px solid #e2e8f0;
}

#vehicleCalculationResult p {
  margin: 0.5rem 0;
}

/* Vehicle input sections */
#carInputSection,
#motorcycleInputSection {
  background: white;
  padding: 1rem;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.payment-methods {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin: 1rem 0;
}

.payment-option {
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  background: white;
}

.payment-option:hover {
  border-color: #0d9488;
  background: #f0fdfa;
}

.payment-option.selected {
  border-color: #0d9488;
  background: #f0fdfa;
  box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.payment-option label {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  cursor: pointer;
  margin: 0;
  width: 100%;
  font-weight: 500;
  flex-direction: row; /* Ensure horizontal layout */
}

.payment-option input[type="radio"] {
  margin: 0;
  width: 18px;
  height: 18px;
  flex-shrink: 0; /* Prevent radio button from shrinking */
}

.payment-option.disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background: #f9fafb;
}

.payment-option.disabled:hover {
  border-color: #e5e7eb;
  background: #f9fafb;
}

.payment-option.disabled label {
  cursor: not-allowed;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .payment-option {
    padding: 0.875rem;
  }
  
  .payment-option label {
    font-size: 0.9rem;
    gap: 0.5rem;
  }
}

    @media (max-width: 768px) {
      nav { display: none; }
      .menu-toggle { display: block; }
      .mobile-menu.show { display: flex; }
      .welcome-mobile { display: block; }
      #welcomeText { display: none; }
      .dropdownNoti {
      display: none;
      position: absolute; right: 20px; top: 50px;
      left: auto;
      background: white; width: 320px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 8px; 
      overflow-y: auto;       /* enable vertical scroll */
      max-height: 60vh;       /* limit height to 60% of screen */
      z-index: 999;
    }
  .dropdownNoti.active {
    display: block;
  } 
    }
    @media (max-width: 600px) {
      .form-group label { min-width: 100%; }
    }
  </style>
</head>
<body>
<header>
    <div class="logo">üèïÔ∏è Campsite Admin Portal</div>
    <div class="welcome-mobile" id="mobileWelcome"></div>
    <div class="bell" onclick="handleBellClick()">
     üîî <span id="badge" class="badge" style="display:none">0</span>
    </div>
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <nav>
      <span id="welcomeText" style="margin-right: 1rem; font-weight: bold;"></span>
      <button class="tab" onclick="location.href='adminpage.html'">Dashboard</button>
      <button class="tab" onclick="location.href='apPendingCom.html'">Pending Commissions</button>

      <div class="dropdown">
      <button class="dropdown-btn">Block & Hold ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab" onclick="location.href='apBlockDate.html'">Block Dates</button>
       <button class="tab" onclick="location.href='apHoldUnit.html'">Hold Unit</button>      
      </div>
      </div>

      <div class="dropdown">
      <button class="dropdown-btn">Financials ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab" onclick="location.href='apExpenses.html'">Expense Tracker</button>
       <button class="tab" onclick="location.href='apOtherIncome.html'">Other Income</button>
       <button class="tab" onclick="location.href='apReport.html'">Monthly Report</button>
      </div>
      </div>
      
      <div class="dropdown">
      <button class="dropdown-btn">C.O ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab" onclick="location.href='apCoView.html'">C.O View</button>
       <button class="tab" onclick="location.href='apCoData.html'">C.O Data</button>
      </div>
      </div>

      <button class="tab" onclick="location.href='apCheckAvailability.html'">Check Availability</button>
      <button class="tab active">New Booking</button>
      <button class="tab" onclick="location.href='apAllBooking.html'">All Bookings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
      <button class="tab" onclick="location.href='adminpage.html'">Dashboard</button>
      <button class="tab" onclick="location.href='apPendingCom.html'">Pending Commissions</button>
      <button class="tab" onclick="location.href='apBlockDate.html'">Block Dates</button>
      <button class="tab" onclick="location.href='apHoldUnit.html'">Hold Unit</button>
      <button class="tab" onclick="location.href='apExpenses.html'">Expense Tracker</button>
      <button class="tab" onclick="location.href='apOtherIncome.html'">Other Income</button>
      <button class="tab" onclick="location.href='apReport.html'">Monthly Report</button>
      <button class="tab" onclick="location.href='apCoView.html'">C.O View</button>
      <button class="tab" onclick="location.href='apCoData.html'">C.O Data</button>
      <button class="tab" onclick="location.href='apCheckAvailability.html'">Check Availability</button>
      <button class="tab active">New Booking</button>
      <button class="tab" onclick="location.href='apAllBooking.html'">All Bookings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>
<main>
  <h2>New Booking</h2>
  <div class="card">
    <div class="form-group">
      <label>Check-in Date <input type="date" id="checkin" /></label>
      <label>Check-out Date <input type="date" id="checkout" /></label>
    </div>
    <div class="form-group">
      <label>Pondok A‚ÄëTent <input type="number" id="qtyTentA" value="0" min="0" /></label>
      <label>Camp‚ÄëLot A <input type="number" id="qtyLotA" value="0" min="0" /></label>
    </div>
    <div class="form-group">
      <label>Camp‚ÄëLot B <input type="number" id="qtyLotB" value="0" min="0" /></label>
      <label>Camp‚ÄëLot C <input type="number" id="qtyLotC" value="0" min="0" /></label>
    </div>
    <div class="form-group">
      <label>Total Pax <input type="number" id="totalPax" value="0" min="0" onchange="calculateAllowedVehicles()" /></label>
      <button onclick="checkPaxSummary()" style="background:#4f46e5;color:white;padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;height:42px;align-self:flex-end">Check Total Pax</button>
    </div>

<!-- Add this Drop-off checkbox section AFTER the vehicle section and BEFORE the customer details -->
<div class="card" id="dropoffCard" style="background: #f8fafc; border-left: 4px solid #3b82f6; display: none;">
  <h3>üöï Drop-off Only</h3>
  <div class="form-group">
    <label style="flex-direction: row; align-items: center; gap: 10px;">
      <input type="checkbox" id="dropoffOnly" onchange="toggleDropoffService()" />
      <span>This is a Drop-off Only booking (no parking vehicle)</span>
    </label>
  </div>
</div>

<!-- Add this VEHICLE CALCULATION SECTION -->
<div class="card" id="vehicleCalculationCard" style="display: none;">
  <h3>üöó Vehicle Allocation</h3>
  <div id="vehicleCalculationResult"></div>
  
  <div class="form-group">
    <label style="flex-direction: row; align-items: center; gap: 10px;">
      <input type="checkbox" id="useCars" onchange="toggleVehicleInputs()" />
      <span>Register Cars</span>
    </label>
    <label style="flex-direction: row; align-items: center; gap: 10px;">
      <input type="checkbox" id="useMotorcycles" onchange="toggleVehicleInputs()" />
      <span>Register Motorcycles</span>
    </label>
  </div>

  <!-- Car Input Section -->
  <div id="carInputSection" style="display: none; margin-top: 1rem;">
    <div class="form-group">
      <label>Number of Cars 
        <input type="number" id="carQty" value="0" min="0" onchange="validateVehicleQty('car')" />
      </label>
      <label>Car Plate Numbers (separate by comma)
        <input type="text" id="carPlates" placeholder="e.g., ABC1234, XYZ5678" />
      </label>
    </div>
  </div>

  <!-- Motorcycle Input Section -->
  <div id="motorcycleInputSection" style="display: none; margin-top: 1rem;">
    <div class="form-group">
      <label>Number of Motorcycles 
        <input type="number" id="motorcycleQty" value="0" min="0" onchange="validateVehicleQty('motorcycle')" />
      </label>
      <label>Motorcycle Plate Numbers (separate by comma)
        <input type="text" id="motorcyclePlates" placeholder="e.g., MCD1234, MEF5678" />
      </label>
    </div>
  </div>
</div>

    <div class="form-group">
      <label>Name <input type="text" id="name" /></label>
      <label>Phone <input type="text" id="phone" /></label>
    </div>
    <div class="form-group">
      <label>Email <input type="email" id="email" /></label>
      <label>Total Price (RM) <input type="text" id="total" /></label>
    </div>
<div class="form-group">
  <div class="payment-methods">
<p>Payment Methods :</p>
    <div class="payment-option" onclick="selectPaymentMethod('fpx')">
      <label>
        <input type="radio" name="paymentMethod" value="fpx" /> 
        Pay by FPX (for Malaysia Only)
      </label>
    </div>
    <div class="payment-option disabled" onclick="selectPaymentMethod('card')">
     <label>
       <input type="radio" name="paymentMethod" value="card" disabled /> 
       Pay by Card (for Visa/Mastercard) - Currently Unavailable
     </label>
   </div>
    <div class="payment-option" onclick="selectPaymentMethod('qr')">
      <label>
        <input type="radio" name="paymentMethod" value="qr" />
         Pay by QR (for direct Booking & Walk-in Only)
      </label>
    </div>
    <div class="payment-option" onclick="selectPaymentMethod('cash')">
      <label>
        <input type="radio" name="paymentMethod" value="cash" /> 
        Pay by Cash (for Walk-in Only)
      </label>
    </div>
  </div>
</div>

    <button class="btn-main" onclick="submitBooking()">Submit Booking</button>
    <button id="sendInvoiceBtn" class="btn-main" style="background: #10b981; display: none; margin-top: 10px;" onclick="sendInvoiceToCustomer()">
  üìß Send Invoice to Customer
</button>
    <div id="paymentLinkContainer" style="margin-top: 1rem;"></div>
  </div>
</main>
<div id="loadingOverlay"><div class="loading-popup">Double Checking Availability...</div></div>
<div id="paymentLoadingOverlay" style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
  <div class="loading-popup">Generating payment link...</div>
</div>
  <div id="dropdownNoti" class="dropdownNoti"></div>

<audio id="dingSound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg">
</audio>
<script>
const username = localStorage.getItem("username") || "Admin";

// üîê Redirect if not logged in
if (!localStorage.getItem("username") || localStorage.getItem("username") === "Admin") {
  window.location.href = "index.html";
} else {
  // Check user's type
  fetch("https://script.google.com/macros/s/AKfycbwZYyoTqEYrTzk2mLPDer4RoLysmRVXakI4__TvENZ4GZRzMFvDcFOP8FX3xqG4hPv2TQ/exec")
    .then(res => res.json())
    .then(data => {
      const users = data.users || [];
      const currentUser = users.find(u => u.username === username);
      if (!currentUser) {
        alert("‚ö†Ô∏è Username not recognized. Please log in again.");
        localStorage.removeItem("username");
        window.location.href = "index.html";
        return;
      }

      if (["staff", "co"].includes(currentUser.type.toLowerCase())) {
      alert("‚ö†Ô∏è This booking page is for admin only. Please use your own ID and sign in again.");
      localStorage.removeItem("username");
      window.location.href = "index.html";
      return;
      }

      if (currentUser.type.toLowerCase() === "admin") {
      alert("‚ö†Ô∏è Remember: You are logged in as Admin. No commission will be applied to this booking.");
      }
    })
    .catch(() => {
      alert("‚ö†Ô∏è Failed to verify user type. Please try again.");
      localStorage.removeItem("username");
      window.location.href = "index.html";
    });
}

document.getElementById("welcomeText").textContent = `Welcome ${username} !!`;
document.getElementById("mobileWelcome").textContent = `Welcome ${username} !!`;


const deploymentId = "AKfycbwsPIi_Zf7UtwTQJ8BPiLmNR87VxecATUOItw68loKglD60QRcRzeQoqIzyynvTXolipA";
const MAX_UNITS = { tentA: 7, lotA: 1, lotB: 3, lotC: 5 };
function formatPhone(p) {
  const cleaned = p.replace(/\D/g, '');

  // ‚ùå Reject any number starting with 0
  if (cleaned.startsWith('0')) {
    alert("‚ùå Please enter valid international format. Example: +60123456789");
    throw new Error("Phone number must be in international format.");
  }

  // ‚úÖ Accept numbers like 60123456789
  if (/^6\d{8,12}$/.test(cleaned)) return cleaned;

  // ‚úÖ Accept international format with + (e.g., +60123456789 or +6581234567)
  if (/^\+\d{8,15}$/.test(p)) return p.replace('+', '');

  // üö´ Everything else: reject
  alert("‚ùå Please enter valid international format. Example: +60123456789");
  throw new Error("Invalid phone number format");
}

function toggleMenu() {
  document.getElementById("mobileMenu").classList.toggle("show");
}

function logout() {
  localStorage.removeItem("username");
  window.location.href = "index.html";
}

function toDMY(dateStr) {
  const [y, m, d] = dateStr.split("-");
  return `${d}/${m}/${y}`;
}

// Add this function to handle dropoff service toggle
function toggleDropoffService() {
  const dropoffChecked = document.getElementById("dropoffOnly").checked;
  const vehicleCard = document.getElementById("vehicleCalculationCard");
  
  if (dropoffChecked) {
    // If dropoff is checked, hide vehicle section
    vehicleCard.style.display = 'none';
    
    // Also uncheck and hide vehicle inputs
    document.getElementById("useCars").checked = false;
    document.getElementById("useMotorcycles").checked = false;
    document.getElementById("carInputSection").style.display = 'none';
    document.getElementById("motorcycleInputSection").style.display = 'none';
    
    // Reset vehicle values
    document.getElementById("carQty").value = 0;
    document.getElementById("carPlates").value = "";
    document.getElementById("motorcycleQty").value = 0;
    document.getElementById("motorcyclePlates").value = "";
  } else {
    // If dropoff is unchecked, show vehicle section (it will be shown if there are pax)
    const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
    if (totalPax > 0) {
      vehicleCard.style.display = 'block';
    }
  }
}

// Vehicle calculation function
function calculateAllowedVehicles() {
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  const vehicleCard = document.getElementById("vehicleCalculationCard");
  const dropoffCard = document.getElementById("dropoffCard");
  const resultDiv = document.getElementById("vehicleCalculationResult");

  // Show/hide both cards based on total pax
  if (!totalPax || isNaN(totalPax)) {
    vehicleCard.style.display = 'none';
    dropoffCard.style.display = 'none';
    return;
  }

  // Show both cards when there are pax
  vehicleCard.style.display = 'block';
  dropoffCard.style.display = 'block';

  // Pax-per-vehicle rules (same as your BotPress logic)
  const MAX_PAX_PER_CAR = 4;
  const MAX_PAX_PER_MOTORCYCLE = 1;

  // Calculate allowed vehicles
  const allowedCars = Math.ceil(totalPax / MAX_PAX_PER_CAR);
  const allowedMotorcycles = Math.ceil(totalPax / MAX_PAX_PER_MOTORCYCLE);

  // Store globally for validation
  window.allowedCars = allowedCars;
  window.allowedMotorcycles = allowedMotorcycles;

  // Display results
  resultDiv.innerHTML = `
    <p><strong>Since total pax is = ${totalPax} pax</strong></p>
    <p>üöó For Cars: you can register up to <strong>${allowedCars}</strong> car(s)</p>
    <p>üèçÔ∏è For Motorcycles: you can register up to <strong>${allowedMotorcycles}</strong> motorcycle(s)</p>
    <p style="font-size: 0.9rem; color: #666;">üí° You can mix cars and motorcycles, but total vehicle capacity cannot exceed ${totalPax + 4} pax</p>
  `;
  
  // Store calculated values for validation
  document.getElementById('carQty').setAttribute('data-max', allowedCars);
  document.getElementById('motorcycleQty').setAttribute('data-max', allowedMotorcycles);
}

// Helper function to calculate total vehicle capacity
function calculateVehicleCapacity() {
  const vehicleData = getVehicleData();
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  
  const PAX_PER_CAR = 4;
  const PAX_PER_MOTORCYCLE = 1;
  
  const coveredPax = (vehicleData.cars.quantity || 0) * PAX_PER_CAR + 
                     (vehicleData.motorcycles.quantity || 0) * PAX_PER_MOTORCYCLE;
  
  const ALLOWED_OVERPAX = 4;
  const maxAllowedCoverage = totalPax + ALLOWED_OVERPAX;
  
  return {
    coveredPax,
    maxAllowedCoverage,
    isOverCapacity: coveredPax > maxAllowedCoverage
  };
}

// Toggle vehicle input sections
function toggleVehicleInputs() {
  const useCars = document.getElementById("useCars").checked;
  const useMotorcycles = document.getElementById("useMotorcycles").checked;
  
  document.getElementById("carInputSection").style.display = useCars ? 'block' : 'none';
  document.getElementById("motorcycleInputSection").style.display = useMotorcycles ? 'block' : 'none';
  
  if (!useCars) {
    document.getElementById("carQty").value = 0;
    document.getElementById("carPlates").value = "";
  }
  if (!useMotorcycles) {
    document.getElementById("motorcycleQty").value = 0;
    document.getElementById("motorcyclePlates").value = "";
  }

  // Validate capacity when toggling
  if (useCars || useMotorcycles) {
    const capacity = calculateVehicleCapacity();
    if (capacity.isOverCapacity) {
      alert(`‚ö†Ô∏è Vehicle capacity warning: Selected vehicles cover ${capacity.coveredPax} pax, but total pax is only ${capacity.maxAllowedCoverage - 4} pax (with 4 pax buffer).`);
    }
  }
}

// Validate vehicle quantity
function validateVehicleQty(type) {
  const input = document.getElementById(`${type}Qty`);
  const maxAllowed = parseInt(input.getAttribute('data-max')) || 0;
  const currentValue = parseInt(input.value) || 0;
  
  if (currentValue > maxAllowed) {
    alert(`‚ùå Maximum allowed ${type}s is ${maxAllowed}`);
    input.value = maxAllowed;
    return;
  }
  
  if (currentValue < 0) {
    input.value = 0;
    return;
  }

  // Check overcapacity when both vehicle types are used
  const capacity = calculateVehicleCapacity();
  if (capacity.isOverCapacity) {
    alert(`‚ö†Ô∏è Vehicle capacity warning: Selected vehicles cover ${capacity.coveredPax} pax, but total pax is only ${capacity.maxAllowedCoverage - 4} pax (with 4 pax buffer). Please reduce vehicle quantities.`);
  }
}

// Update the getVehicleData function to include dropoff info
function getVehicleData() {
  const dropoffOnly = document.getElementById("dropoffOnly").checked;
  const useCars = document.getElementById("useCars").checked;
  const useMotorcycles = document.getElementById("useMotorcycles").checked;
  
  const vehicleData = {
    dropoffOnly: dropoffOnly,
    cars: {
      registered: useCars,
      quantity: useCars ? parseInt(document.getElementById("carQty").value) || 0 : 0,
      plates: useCars ? document.getElementById("carPlates").value.trim() : ""
    },
    motorcycles: {
      registered: useMotorcycles,
      quantity: useMotorcycles ? parseInt(document.getElementById("motorcycleQty").value) || 0 : 0,
      plates: useMotorcycles ? document.getElementById("motorcyclePlates").value.trim() : ""
    }
  };
  
  return vehicleData;
}

// Update the vehicle validation to skip vehicle checks for dropoff
function validateVehicleData() {
  const vehicleData = getVehicleData();
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  
  // If it's dropoff only, skip all vehicle validations
  if (vehicleData.dropoffOnly) {
    return true;
  }
  
  // Pax-per-vehicle rules (only for non-dropoff bookings)
  const PAX_PER_CAR = 4;
  const PAX_PER_MOTORCYCLE = 1;
  
  // Get allowed vehicle counts
  const allowedCars = Math.ceil(totalPax / PAX_PER_CAR);
  const allowedMotorcycles = Math.ceil(totalPax / PAX_PER_MOTORCYCLE);

  // 1Ô∏è‚É£ Check if plates match quantity
  if (vehicleData.cars.registered && vehicleData.cars.quantity > 0) {
    const carPlates = vehicleData.cars.plates.split(/[, ]+/).filter(plate => plate.trim() !== "");
    if (carPlates.length !== vehicleData.cars.quantity) {
      alert(`‚ùå You selected ${vehicleData.cars.quantity} car(s) but entered ${carPlates.length} plate number(s).`);
      return false;
    }
  }
  
  if (vehicleData.motorcycles.registered && vehicleData.motorcycles.quantity > 0) {
    const motorcyclePlates = vehicleData.motorcycles.plates.split(/[, ]+/).filter(plate => plate.trim() !== "");
    if (motorcyclePlates.length !== vehicleData.motorcycles.quantity) {
      alert(`‚ùå You selected ${vehicleData.motorcycles.quantity} motorcycle(s) but entered ${motorcyclePlates.length} plate number(s).`);
      return false;
    }
  }

  // 2Ô∏è‚É£ Per-type allowed checks
  if (vehicleData.cars.registered && vehicleData.cars.quantity > allowedCars) {
    alert(`‚ùå You selected ${vehicleData.cars.quantity} car(s) but are allowed up to ${allowedCars} car(s) for ${totalPax} pax.`);
    return false;
  }

  if (vehicleData.motorcycles.registered && vehicleData.motorcycles.quantity > allowedMotorcycles) {
    alert(`‚ùå You selected ${vehicleData.motorcycles.quantity} motorcycle(s) but are allowed up to ${allowedMotorcycles} motorcycle(s) for ${totalPax} pax.`);
    return false;
  }

  // 3Ô∏è‚É£ Overcapacity check
  const coveredPax = (vehicleData.cars.quantity || 0) * PAX_PER_CAR + 
                     (vehicleData.motorcycles.quantity || 0) * PAX_PER_MOTORCYCLE;
  
  const ALLOWED_OVERPAX = 4;
  const maxAllowedCoverage = totalPax + ALLOWED_OVERPAX;

  if (coveredPax > maxAllowedCoverage) {
    alert(`‚ö†Ô∏è The vehicles you selected cover ${coveredPax} pax, which exceeds the total pax ${totalPax} pax (with ${ALLOWED_OVERPAX} pax buffer). Please reduce your vehicles.`);
    return false;
  }

  // ‚úÖ All checks passed
  return true;
}

// Update the format vehicle data function to handle dropoff
function formatVehicleData() {
  const vehicleData = getVehicleData();
  
  // If dropoff only, return "Drop-off" for the remark
  if (vehicleData.dropoffOnly) {
    return "Drop-off only";
  }
  
  // Otherwise, format vehicle data as before
  let vehicleRemark = "";
  if (vehicleData.cars.registered && vehicleData.cars.quantity > 0) {
    vehicleRemark += `CAR: ${vehicleData.cars.plates}`;
  }
  if (vehicleData.motorcycles.registered && vehicleData.motorcycles.quantity > 0) {
    // Add a space before MOTORCYCLE if there's already car data
    if (vehicleRemark) {
      vehicleRemark += " ";
    }
    vehicleRemark += `MOTORCYCLE: ${vehicleData.motorcycles.plates}`;
  }
  return vehicleRemark.trim();
}

// Helper function to format vehicle data for messages
function formatVehicleDataForMessage() {
  const vehicleData = getVehicleData();
  
  // If dropoff only, return "Drop-off only"
  if (vehicleData.dropoffOnly) {
    return "Drop-off only";
  }
  
  let vehicleMessage = "";
  if (vehicleData.cars.registered && vehicleData.cars.quantity > 0) {
    vehicleMessage += `CAR: ${vehicleData.cars.plates}`;
  }
  if (vehicleData.motorcycles.registered && vehicleData.motorcycles.quantity > 0) {
    // Add a new line before MOTORCYCLE if there's already car data
    if (vehicleMessage) {
      vehicleMessage += "\n";
    }
    vehicleMessage += `MOTORCYCLE: ${vehicleData.motorcycles.plates}`;
  }
  
  // If no vehicles registered, show "No vehicle registered"
  if (!vehicleMessage) {
    vehicleMessage = "No vehicle registered";
  }
  
  return vehicleMessage;
}

function submitCashBooking(name, phone, email, total, checkin, checkout, selectedQty, totalPax, extraPax, vehicleRemark, callback) {
  // Generate cash booking ID
  const cashBookId = "cash_" + Date.now();

  // Store it for the invoice
  localStorage.setItem('lastCashBookingId', cashBookId);
  
  const postData = new URLSearchParams();
  postData.append("userId", username);
  postData.append("custName", name);
  postData.append("custPhone", phone);
  postData.append("custEmail", email);
  postData.append("totalPrice", total);
  postData.append("startDate", checkin);
  postData.append("endDate", checkout);
  postData.append("quantityATent", selectedQty.tentA);
  postData.append("quantityLotA", selectedQty.lotA);
  postData.append("quantityLotB", selectedQty.lotB);
  postData.append("quantityLotC", selectedQty.lotC);
  postData.append("totalPax", totalPax);
  postData.append("extraPax", extraPax);
  postData.append("bookId", cashBookId);
  postData.append("remark", vehicleRemark.trim()); // Use the same formatted vehicle remark

  fetch(`https://script.google.com/macros/s/${deploymentId}/exec`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: postData.toString()
  })
    .then(res => res.text())
    .then(() => {
      // Simulate webhook after 5 seconds
      setTimeout(() => {
        simulateCashWebhook(phone, total, cashBookId);
      }, 5000);
      
      // Send notification
      const notifyData = new URLSearchParams();
      notifyData.append("message", `New booking by ${name} ${phone} !!`);
      notifyData.append("from", "Admin Portal");
      notifyData.append("agent", username);

      fetch("https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: notifyData.toString()
      });

      callback(true);
    })
    .catch(err => {
      console.error("Cash booking error:", err);
      callback(false);
    });
}

function simulateCashWebhook(phone, amount, billCode) {
  const webhookData = {
    status: "1",
    order_id: `${phone}|${phone}`,
    billCode: billCode,
    amount: parseFloat(amount)
  };

  // Use URLSearchParams instead of JSON to avoid CORS preflight
  const formData = new URLSearchParams();
  formData.append("status", "1");
  formData.append("order_id", `${phone}|${phone}`);
  formData.append("billCode", billCode);
  formData.append("amount", parseFloat(amount).toString());

  // Send to your Google Apps Script webhook URL using form data
  fetch(`https://script.google.com/macros/s/${deploymentId}/exec`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: formData.toString()
  })
  .then(response => response.text())
  .then(result => {
    console.log("Cash webhook simulated successfully for:", billCode);
    console.log("Response:", result);
  })
  .catch(error => {
    console.error("Error simulating cash webhook:", error);
  });
}

function submitQRBooking(name, phone, email, total, checkin, checkout, selectedQty, totalPax, extraPax, vehicleRemark, callback) {
  // Generate QR booking ID
  const qrBookId = "qr_" + Date.now();

  // Store it for the invoice
  localStorage.setItem('lastQRBookingId', qrBookId);
  
  const postData = new URLSearchParams();
  postData.append("userId", username);
  postData.append("custName", name);
  postData.append("custPhone", phone);
  postData.append("custEmail", email);
  postData.append("totalPrice", total);
  postData.append("startDate", checkin);
  postData.append("endDate", checkout);
  postData.append("quantityATent", selectedQty.tentA);
  postData.append("quantityLotA", selectedQty.lotA);
  postData.append("quantityLotB", selectedQty.lotB);
  postData.append("quantityLotC", selectedQty.lotC);
  postData.append("totalPax", totalPax);
  postData.append("extraPax", extraPax);
  postData.append("bookId", qrBookId);
  postData.append("remark", vehicleRemark.trim());

  fetch(`https://script.google.com/macros/s/${deploymentId}/exec`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: postData.toString()
  })
    .then(res => res.text())
    .then(() => {
      // Simulate webhook after 5 seconds (same as cash)
      setTimeout(() => {
        simulateQRWebhook(phone, total, qrBookId);
      }, 5000);
      
      // Send notification
      const notifyData = new URLSearchParams();
      notifyData.append("message", `New booking by ${name} ${phone} !!`);
      notifyData.append("from", "Admin Portal");
      notifyData.append("agent", username);

      fetch("https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: notifyData.toString()
      });

      callback(true);
    })
    .catch(err => {
      console.error("QR booking error:", err);
      callback(false);
    });
}

function simulateQRWebhook(phone, amount, billCode) {
  const webhookData = {
    status: "1",
    order_id: `${phone}|${phone}`,
    billCode: billCode,
    amount: parseFloat(amount)
  };

  const formData = new URLSearchParams();
  formData.append("status", "1");
  formData.append("order_id", `${phone}|${phone}`);
  formData.append("billCode", billCode);
  formData.append("amount", parseFloat(amount).toString());

  fetch(`https://script.google.com/macros/s/${deploymentId}/exec`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: formData.toString()
  })
  .then(response => response.text())
  .then(result => {
    console.log("QR webhook simulated successfully for:", billCode);
    console.log("Response:", result);
  })
  .catch(error => {
    console.error("Error simulating QR webhook:", error);
  });
}

// ... previous code ...

function submitBooking() {
  const checkinStr = document.getElementById("checkin").value;
  const checkoutStr = document.getElementById("checkout").value;
  const total = document.getElementById("total").value.trim();
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  const validTotalPattern = /^\d+(\.\d{2})?$/;

  const selectedQty = {
    tentA: parseInt(document.getElementById("qtyTentA").value) || 0,
    lotA: parseInt(document.getElementById("qtyLotA").value) || 0,
    lotB: parseInt(document.getElementById("qtyLotB").value) || 0,
    lotC: parseInt(document.getElementById("qtyLotC").value) || 0,
  };

// Get vehicle data and format remark
const vehicleData = getVehicleData();
const vehicleRemark = formatVehicleData(); // This will return "Drop-off" or vehicle data

  const errors = [];
  let formattedPhone;

  if (!checkinStr || !checkoutStr) {
    errors.push("‚ùå Please select both check-in and check-out dates.");
  } else if (new Date(checkoutStr) <= new Date(checkinStr)) {
    errors.push("‚ùå Checkout date must be after check-in date.");
  }

  const totalUnits = selectedQty.tentA + selectedQty.lotA + selectedQty.lotB + selectedQty.lotC;
  if (totalUnits === 0) errors.push("‚ùå Please select at least one unit to book.");
  if (totalPax === 0) errors.push("‚ùå Please insert total pax.");
  if (!name) errors.push("‚ùå Please enter your name.");
  if (!phone) errors.push("‚ùå Please enter your phone number.");
  else {
    try {
      formattedPhone = formatPhone(phone);
    } catch {
      errors.push("‚ùå Invalid phone format. Use international format like +60123456789.");
    }
  }
  if (!email || !email.includes("@") || !email.includes(".")) {
    errors.push("‚ùå Please enter a valid email address.");
  }
  if (!total || !validTotalPattern.test(total)) {
    errors.push("‚ùå Please enter a valid total price (e.g., 1547 or 1547.00).");
  }

  // Add vehicle validation
  if (!validateVehicleData()) {
    return;
  }

  // Add payment method validation
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
  if (!paymentMethod) {
    errors.push("‚ùå Please choose payment method.");
  }

  if (errors.length > 0) {
    alert(errors.join("\n"));
    return;
  }

  // PAX validation
  const unitRules = {
    tentA: { base: 4, addon: 3 },
    lotA: { base: 6, addon: 4 },
    lotB: { base: 4, addon: 3 },
    lotC: { base: 2, addon: 2 },
  };

  const basePax =
    selectedQty.tentA * unitRules.tentA.base +
    selectedQty.lotA * unitRules.lotA.base +
    selectedQty.lotB * unitRules.lotB.base +
    selectedQty.lotC * unitRules.lotC.base;

  const maxPax =
    selectedQty.tentA * (unitRules.tentA.base + unitRules.tentA.addon) +
    selectedQty.lotA * (unitRules.lotA.base + unitRules.lotA.addon) +
    selectedQty.lotB * (unitRules.lotB.base + unitRules.lotB.addon) +
    selectedQty.lotC * (unitRules.lotC.base + unitRules.lotC.addon);

  if (totalPax > maxPax) {
    return alert(`‚ùå Total pax (${totalPax}) exceeds maximum allowed (${maxPax}).`);
  }

  const extraPax = Math.max(0, totalPax - basePax);
  const extraCharge = extraPax * 5;

// ‚úÖ All validation passed. Now show booking summary popup.
let vehicleSummary = "";
if (vehicleData.dropoffOnly) {
  vehicleSummary += `Drop-off Only\n`;
} else {
  if (vehicleData.cars.registered && vehicleData.cars.quantity > 0) {
    vehicleSummary += `üöó Cars: ${vehicleData.cars.quantity} (${vehicleData.cars.plates})\n`;
  }
  if (vehicleData.motorcycles.registered && vehicleData.motorcycles.quantity > 0) {
    vehicleSummary += `üèçÔ∏è Motorcycles: ${vehicleData.motorcycles.quantity} (${vehicleData.motorcycles.plates})\n`;
  }
}

  // ‚úÖ All validation passed. Now show booking summary popup.
  const summary = `
‚úÖ Please review your booking:\n
üìÖ Check-in: ${checkinStr}
üìÖ Check-out: ${checkoutStr}
üë§ Name: ${name}
üìû Phone: ${formattedPhone}
üìß Email: ${email}

üèïÔ∏è Units:
- Pondok A‚ÄëTent: ${selectedQty.tentA}
- Camp‚ÄëLot A: ${selectedQty.lotA}
- Camp‚ÄëLot B: ${selectedQty.lotB}
- Camp‚ÄëLot C: ${selectedQty.lotC}

${vehicleSummary ? `üöó Vehicles:\n${vehicleSummary}` : ''}
üßç Total Pax: ${totalPax}
üßç‚Äç‚ôÄÔ∏è Included Pax: ${basePax}
‚ûï Extra Pax: ${extraPax}
üíµ Total Price: RM${total}

Click OK to confirm & proceed.
`;

  if (!confirm(summary)) return;

  // Proceed with availability check & submission
  const checkin = new Date(checkinStr);
  const checkout = new Date(checkoutStr);
  const dates = [];
  let current = new Date(checkin);
  while (current < checkout) {
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }

  document.querySelector(".btn-main").disabled = true;
  document.getElementById("loadingOverlay").style.display = "flex";

  fetch(`https://script.google.com/macros/s/${deploymentId}/exec`)
    .then(res => res.json())
    .then(data => {
      if (!data.bookings) throw new Error("Missing bookings in response");
      const warnings = [];

      dates.forEach(date => {
        const units = calculateAvailability(data.bookings, date);
        units.forEach(unit => {
          const want = selectedQty[unit.key] || 0;
          if (want > 0 && unit.available < want) {
            warnings.push(`${unit.name} only has ${unit.available} left on ${formatDate(date.toISOString())}`);
          }
        });
      });

      if (warnings.length > 0) {
        document.getElementById("loadingOverlay").style.display = "none";
        document.querySelector(".btn-main").disabled = false;
        alert("Limited availability:\n" + warnings.join("\n"));
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

      if (paymentMethod === "fpx") {
        generateToyyibpayLink(name, phone, email, total, toDMY(checkinStr), toDMY(checkoutStr), selectedQty, totalPax, afterPayment);
      } else if (paymentMethod === "card") {
        generateHitpayLink(name, phone, email, total, toDMY(checkinStr), toDMY(checkoutStr), selectedQty, totalPax, afterPayment);
      } else if (paymentMethod === "cash") {
        submitCashBooking(name, formattedPhone, email, total, toDMY(checkinStr), toDMY(checkoutStr), selectedQty, totalPax, extraPax, vehicleRemark, afterPayment);
      } else if (paymentMethod === "qr") {
        submitQRBooking(name, formattedPhone, email, total, toDMY(checkinStr), toDMY(checkoutStr), selectedQty, totalPax, extraPax, vehicleRemark, afterPayment);
}

      function afterPayment(success) {
        if (!success) {
          document.getElementById("loadingOverlay").style.display = "none";
          document.querySelector(".btn-main").disabled = false;
          return;
        }
        
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
if (paymentMethod === "cash" || paymentMethod === "qr") {
    document.getElementById("loadingOverlay").style.display = "none";
    document.getElementById('sendInvoiceBtn').style.display = 'block';
    
    // Store which type of booking for invoice sending
    if (paymentMethod === "cash") {
        localStorage.setItem('lastCashBookingId', localStorage.getItem('lastCashBookingId'));
    } else {
        localStorage.setItem('lastQRBookingId', localStorage.getItem('lastQRBookingId'));
    }
    
    showCustomNotification(`‚úÖ ${paymentMethod.toUpperCase()} booking submitted successfully! Status will update to 'paid' automatically in 5 seconds. Don't forget to send the invoice to customer.`);
    setTimeout(() => location.reload(), 7000);
} else {
          // For online payments, save booking after payment link generation
          const postData = new URLSearchParams();
          postData.append("userId", `${username}`);
          postData.append("custName", name);
          postData.append("custPhone", formattedPhone);
          postData.append("custEmail", email);
          postData.append("totalPrice", total);
          postData.append("startDate", toDMY(checkinStr));
          postData.append("endDate", toDMY(checkoutStr));
          postData.append("quantityATent", selectedQty.tentA);
          postData.append("quantityLotA", selectedQty.lotA);
          postData.append("quantityLotB", selectedQty.lotB);
          postData.append("quantityLotC", selectedQty.lotC);
          postData.append("totalPax", totalPax);
          postData.append("extraPax", extraPax);
          postData.append("remark", vehicleRemark.trim());

          fetch(`https://script.google.com/macros/s/${deploymentId}/exec`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: postData.toString()
          })
            .then(res => res.text())
            .then(() => {
              // === üîî Send notification to notification DB ===
              const notifyData = new URLSearchParams();
              notifyData.append("message", `New booking by ${name} ${formattedPhone} !!`);
              notifyData.append("from", "Admin Portal");
              notifyData.append("agent", username);

              fetch("https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: notifyData.toString()
              }).catch(err => console.error("‚ùå Notification error:", err));

              document.getElementById("loadingOverlay").style.display = "none";
              alert("‚úÖ Booking submitted successfully!");
              setTimeout(() => location.reload(), 7000);
            })
            .catch(err => {
              document.getElementById("loadingOverlay").style.display = "none";
              document.querySelector(".btn-main").disabled = false;
              alert("‚ùå Failed to submit booking: " + err);
            });
        }
      }
    })
    .catch(err => {
      document.getElementById("loadingOverlay").style.display = "none";
      document.querySelector(".btn-main").disabled = false;
      alert("‚ùå Failed to check availability: " + err);
    });
}

function showCustomNotification(message) {
    // Create a custom notification div
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: bold;
        max-width: 400px;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function selectPaymentMethod(method) {
  // Prevent selection if method is disabled
  if (method === 'card') {
    alert("‚ùå Card payment is currently unavailable. Please choose another payment method.");
    return;
  }

  // Update radio button
  document.querySelector(`input[value="${method}"]`).checked = true;
  
  // Update card styles
  document.querySelectorAll('.payment-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  document.querySelector(`.payment-option[onclick="selectPaymentMethod('${method}')"]`).classList.add('selected');
  
  // Trigger the alert
  handlePaymentMethodAlert();
}

function sendInvoiceToCustomer() {
  // At the beginning of the function, determine which booking ID to use
  let bookingId;
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

  if (paymentMethod === "cash") {
    bookingId = localStorage.getItem('lastCashBookingId');
  } else if (paymentMethod === "qr") {
    bookingId = localStorage.getItem('lastQRBookingId');
  } else {
    alert("‚ùå This function is only for cash/QR bookings");
    return;
  }

  if (!bookingId) {
    alert("‚ùå No booking ID found. Please submit the booking first.");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const total = document.getElementById("total").value.trim();
  const checkinStr = document.getElementById("checkin").value;
  const checkoutStr = document.getElementById("checkout").value;
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  
  const selectedQty = {
    tentA: parseInt(document.getElementById("qtyTentA").value) || 0,
    lotA: parseInt(document.getElementById("qtyLotA").value) || 0,
    lotB: parseInt(document.getElementById("qtyLotB").value) || 0,
    lotC: parseInt(document.getElementById("qtyLotC").value) || 0,
  };

  // Validate required fields
  if (!name || !phone || !checkinStr || !checkoutStr) {
    alert("‚ùå Please fill in all booking details before sending invoice.");
    return;
  }

  try {
    const formattedPhone = formatPhone(phone);
    
    // Create QR code URL - USE bookingId NOT cashBookId
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${bookingId}`;
    
    // Create the WhatsApp message - USE bookingId NOT cashBookId
    const message = `Thank You!!

Here is your QR code: ${qrCodeUrl}

Booking Detail:

üÜî Booking Id: ${bookingId}
üë§ Name: ${name}
üìû Phone: ${phone}
üìß Email: ${email}
üÖøÔ∏è Registered Camper Plate: 
${formatVehicleDataForMessage()}

üìÖ Check-in: ${toDMY(checkinStr)}
üìÖ Check-out: ${toDMY(checkoutStr)}
üèïÔ∏è Units:
- Pondok A‚ÄëTent: ${selectedQty.tentA}
- Camp‚ÄëLot A: ${selectedQty.lotA}
- Camp‚ÄëLot B: ${selectedQty.lotB}
- Camp‚ÄëLot C: ${selectedQty.lotC}
üßç Total Pax: ${totalPax}
üíµ Total Price: RM${total}`;

    // Encode the message for WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    
    // Create WhatsApp URL
    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
    
    // Hide the button immediately when clicked
    document.getElementById('sendInvoiceBtn').style.display = 'none';

    // ‚úÖ CLEAR BOTH booking IDs from localStorage after use
    localStorage.removeItem('lastCashBookingId');
    localStorage.removeItem('lastQRBookingId');
    
    // Open WhatsApp in new tab
    window.open(whatsappUrl, '_blank');
    
    // Show success message
    alert("‚úÖ WhatsApp opened with invoice message! Please send it to the customer.");
    
  } catch (error) {
    alert("‚ùå Error preparing invoice: " + error.message);
  }
}

function handlePaymentMethodAlert() {
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  const totalPrice = parseFloat(document.getElementById("total").value) || 0;
  
  switch(paymentMethod) {
    case 'fpx':
      if (totalPrice > 0) {
        alert(`Total Price + RM1(Toyyibpay Fee) = RM${(totalPrice + 1).toFixed(2)}`);
      } else {
        alert("Pay by FPX (for Malaysia Only) - Total Price + RM1(Toyyibpay Fee) = Actual Total Price");
      }
      break;
      
    case 'card':
      if (totalPrice > 0) {
        const cardTotal = (totalPrice * 1.05) + 1;
        alert(`Total Price * 5% + RM1(Hitpay Fee) = RM${cardTotal.toFixed(2)}`);
      } else {
        alert("Pay by Card (for Visa/Mastercard) - Total Price * 5% + RM1(Hitpay Fee) = Actual Total Price");
      }
      break;

    case 'qr':
      alert("Pay by QR (for direct Booking & Walk-in Only) - Please make sure customer shows payment confirmation before submitting");
      break;
      
    case 'cash':
      alert("Pay by Cash (for Walk-in Only) - Please make sure you receive payment before submit this booking");
      break;
  }
}

// ... rest of your code ...

let lastPaymentLink = ""; // ‚úÖ store generated link for copy

function generateToyyibpayLink(name, phone, email, amount, checkin, checkout, selectedQty, totalPax, callback) {
  document.getElementById("paymentLoadingOverlay").style.display = "flex";

  const userSecretKey = "b8i1lou9-73pz-uufr-4wub-kg3knagpoisp";
  const categoryCode = "rolv7s75";
  const billName = "Booking Payment";
  const billDescription = "Camp Booking via MK Rimba Admin Portal";
  const returnUrl = "https://payment.mkrimbacamp-vr.com";
  const callbackUrl = "https://script.google.com/macros/s/AKfycbwsPIi_Zf7UtwTQJ8BPiLmNR87VxecATUOItw68loKglD60QRcRzeQoqIzyynvTXolipA/exec";

  const amountInSen = parseInt(parseFloat(amount) * 100); 
  const nowUtc = new Date();
  const expiryMyTime = new Date(nowUtc.getTime() + (5 + 480) * 60 * 1000);
  const formattedExpiry = expiryMyTime.toISOString().split('.')[0].replace('T', ' ');

  const params = new URLSearchParams();
  params.append("userSecretKey", userSecretKey);
  params.append("categoryCode", categoryCode);
  params.append("billName", billName);
  params.append("billDescription", billDescription);
  params.append("billPriceSetting", "1");
  params.append("billPayorInfo", "1");
  params.append("billAmount", amountInSen.toString());
  params.append("billReturnUrl", returnUrl);
  params.append("billCallbackUrl", callbackUrl);
  params.append("billTo", name || "Customer");
  params.append("billEmail", email || "test@example.com");
  params.append("billPhone", formatPhone(phone || "60123456789"));
  params.append("billExpiryDate", formattedExpiry);
  params.append("billExternalReferenceNo", `${formatPhone(phone || "60123456789")}|${formatPhone(phone || "60123456789")}`);

  fetch("https://toyyibpay.com/index.php/api/createBill", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params.toString()
  })
    .then(res => res.json())
    .then(data => {
      document.getElementById("paymentLoadingOverlay").style.display = "none";
      if (Array.isArray(data) && data[0]?.BillCode) {
        const link = `https://toyyibpay.com/${data[0].BillCode}`;
        lastPaymentLink = link;
        window.open(link, "_blank");

        const qrLink = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${data[0].BillCode}`;

 // üèïÔ∏è Unit Breakdown
        const units = `
- Pondok A‚ÄëTent: ${selectedQty.tentA}
- Camp‚ÄëLot A: ${selectedQty.lotA}
- Camp‚ÄëLot B: ${selectedQty.lotB}
- Camp‚ÄëLot C: ${selectedQty.lotC}
        `.trim();

const msg = `Here is your payment link: ${link}

‚ö†Ô∏è Important: This payment link will expire in 5 minutes ‚è∞. If payment is not completed, your booking will be cancelled and the unit will be released to the next customer.

Here is your QR code: ${qrLink}

üì≤ After making payment, please show this QR to our camp officer during your check-in.

Booking Detail:

üÜî Booking Id: ${data[0].BillCode}
üë§ Name: ${name}
üìû Phone: ${phone}
üìß Email: ${email}
üÖøÔ∏è Registered Camper Plate: 
${formatVehicleDataForMessage()}

üìÖ Check-in: ${checkin}
üìÖ Check-out: ${checkout}
üèïÔ∏è Units:
${units}
üßç Total Pax: ${totalPax}
üíµ Total Price: RM${amount}
`;

        const container = document.getElementById("paymentLinkContainer");
        container.innerHTML = `
          <button onclick="copyPaymentMessage()" style="margin-top: 10px; background: #f59e0b; color: white; border: none; padding: 0.7rem; border-radius: 6px; cursor: pointer;">
            üìã Send payment link to customer
          </button>
        `;
        window.copyPaymentMessage = () => {
          navigator.clipboard.writeText(msg).then(() => {
            alert("Payment message copied to clipboard!");
          });
        };

        callback(true);
      } else {
        alert("‚ùå Error generating payment link. Please try again later.");
        document.querySelector(".btn-main").disabled = false;
        callback(false);
      }
    })
    .catch(err => {
      document.getElementById("paymentLoadingOverlay").style.display = "none";
      alert("‚ùå Payment error: " + err.message);
      document.querySelector(".btn-main").disabled = false;
      callback(false);
    });
}

function generateHitpayLink(name, phone, email, amount, checkin, checkout, selectedQty, totalPax, callback) {
  document.getElementById("paymentLoadingOverlay").style.display = "flex";

  const apiKey = "test_278603db184930b3c1fb4798b0d79fd51c006fb6e8ea5e3a18e633b18f005bc7";
  const redirectUrl = "https://payment.mkrimbacamp-vr.com";
  const webhookUrl = "https://script.google.com/macros/s/AKfycbwsPIi_Zf7UtwTQJ8BPiLmNR87VxecATUOItw68loKglD60QRcRzeQoqIzyynvTXolipA/exec";
  const purposeDescription = "Camp Booking via MK Rimba Admin Portal";

  const nowUtc = new Date();
  const expiryMyTime = new Date(nowUtc.getTime() + (5 + 480) * 60 * 1000);
  const formattedExpiry = expiryMyTime.toISOString().split('.')[0].replace('T', ' ');

  // Use CORS proxy
  const proxyUrl = 'https://corsproxy.io/?';
  const targetUrl = 'https://api.sandbox.hit-pay.com/v1/payment-requests';

  const formData = new URLSearchParams();
  formData.append("amount", parseFloat(amount).toFixed(2));
  formData.append("currency", "MYR");
  formData.append("name", name || "Customer");
  formData.append("email", email || "test@example.com");
  formData.append("phone", formatPhone(phone || "60123456789"));
  formData.append("purpose", purposeDescription);
  formData.append("reference_number", `${formatPhone(phone || "60123456789")}|${formatPhone(phone || "60123456789")}`);
  formData.append("redirect_url", redirectUrl);
  formData.append("webhook", webhookUrl);
  formData.append("payment_methods[]", "card");
  formData.append("allow_repeated_payments", "false");
  formData.append("expiry_date", formattedExpiry);
  formData.append("send_email", "true");

  fetch(proxyUrl + encodeURIComponent(targetUrl), {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-BUSINESS-API-KEY": apiKey
    },
    body: formData.toString()
  })
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      document.getElementById("paymentLoadingOverlay").style.display = "none";
      console.log("HitPay response:", data);
      
      if (data.url) {
        window.open(data.url, "_blank");
        lastPaymentLink = data.url;

const qrLink = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${data.id}`;

        // Create comprehensive message like ToyyibPay
        const units = `
- Pondok A‚ÄëTent: ${selectedQty.tentA}
- Camp‚ÄëLot A: ${selectedQty.lotA}
- Camp‚ÄëLot B: ${selectedQty.lotB}
- Camp‚ÄëLot C: ${selectedQty.lotC}
        `.trim();

        const msg = `Here is your card payment link: ${data.url}

‚ö†Ô∏è Important: This payment link will expire in 5 minutes ‚è∞. If payment is not completed, your booking will be cancelled and the unit will be released to the next customer.

Here is your QR code: ${qrLink}

üì≤ After making payment, please show this QR to our camp officer during your check-in.

Booking Detail:

üÜî Booking Id: ${data.id}
üë§ Name: ${name}
üìû Phone: ${phone}
üìß Email: ${email}
üÖøÔ∏è Registered Camper Plate: 
${formatVehicleDataForMessage()}

üìÖ Check-in: ${checkin}
üìÖ Check-out: ${checkout}
üèïÔ∏è Units:
${units}
üßç Total Pax: ${totalPax}
üíµ Total Price: RM${amount}
`;

        const container = document.getElementById("paymentLinkContainer");
        container.innerHTML = `
          <button onclick="copyHitpayMessage()" style="margin-top: 10px; background: #f59e0b; color: white; border: none; padding: 0.7rem; border-radius: 6px; cursor: pointer;">
            üìã Send payment link to customer
          </button>
        `;
        
        window.copyHitpayMessage = () => {
          navigator.clipboard.writeText(msg).then(() => {
            alert("Payment message copied to clipboard!");
          });
        };

        callback(true);
      } else {
        alert("‚ùå Error generating HitPay link: " + (data.message || JSON.stringify(data)));
        document.querySelector(".btn-main").disabled = false;
        callback(false);
      }
    })
    .catch(err => {
      document.getElementById("paymentLoadingOverlay").style.display = "none";
      console.error("HitPay error:", err);
      alert("‚ùå HitPay error: " + err.message);
      document.querySelector(".btn-main").disabled = false;
      callback(false);
    });
}

// ... other existing code remains unchanged
function calculateAvailability(bookings, currentDate) {
  const unitCounts = { tentA: 0, lotA: 0, lotB: 0, lotC: 0 };
  bookings.forEach(booking => {
    const bStart = parseSheetDate(booking.checkin);
    const bEnd = parseSheetDate(booking.checkout);
    if (!bStart || !bEnd) return;
    if (bStart <= currentDate && bEnd > currentDate) {
      const units = booking.unit || "";
      unitCounts.tentA += parseInt(units.match(/TentA:\s*(\d+)/)?.[1] || 0);
      unitCounts.lotA += parseInt(units.match(/LotA:\s*(\d+)/)?.[1] || 0);
      unitCounts.lotB += parseInt(units.match(/LotB:\s*(\d+)/)?.[1] || 0);
      unitCounts.lotC += parseInt(units.match(/LotC:\s*(\d+)/)?.[1] || 0);
    }
  });
  return [
    { key: "tentA", name: "Pondok A-Tent", available: Math.max(0, MAX_UNITS.tentA - unitCounts.tentA) },
    { key: "lotA", name: "Camp-Lot A", available: Math.max(0, MAX_UNITS.lotA - unitCounts.lotA) },
    { key: "lotB", name: "Camp-Lot B", available: Math.max(0, MAX_UNITS.lotB - unitCounts.lotB) },
    { key: "lotC", name: "Camp-Lot C", available: Math.max(0, MAX_UNITS.lotC - unitCounts.lotC) }
  ];
}

function parseSheetDate(dateStr) {
  const parts = dateStr.includes("-") ? dateStr.split("-") : dateStr.split("/");
  if (parts.length !== 3) return null;
  try {
    return dateStr.includes("-")
      ? new Date(`${parts[0]}-${parts[1]}-${parts[2]}`)
      : new Date(`${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`);
  } catch { return null; }
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-GB");
}
function checkPaxSummary() {
  const totalPax = parseInt(document.getElementById("totalPax").value) || 0;
  const selectedQty = {
    tentA: parseInt(document.getElementById("qtyTentA").value) || 0,
    lotA: parseInt(document.getElementById("qtyLotA").value) || 0,
    lotB: parseInt(document.getElementById("qtyLotB").value) || 0,
    lotC: parseInt(document.getElementById("qtyLotC").value) || 0,
  };
  const unitRules = {
    tentA: { base: 4, addon: 3 },
    lotA: { base: 6, addon: 4 },
    lotB: { base: 4, addon: 3 },
    lotC: { base: 2, addon: 2 },
  };
  const basePax =
    selectedQty.tentA * unitRules.tentA.base +
    selectedQty.lotA * unitRules.lotA.base +
    selectedQty.lotB * unitRules.lotB.base +
    selectedQty.lotC * unitRules.lotC.base;
  const maxPax =
    selectedQty.tentA * (unitRules.tentA.base + unitRules.tentA.addon) +
    selectedQty.lotA * (unitRules.lotA.base + unitRules.lotA.addon) +
    selectedQty.lotB * (unitRules.lotB.base + unitRules.lotB.addon) +
    selectedQty.lotC * (unitRules.lotC.base + unitRules.lotC.addon);
  if (totalPax > maxPax) {
    alert(`‚ùå Total pax (${totalPax}) exceeds the maximum allowed (${maxPax}). Please reduce total pax.`);
    return;
  }
  const extraPax = Math.max(0, totalPax - basePax);
  const extraCharge = extraPax * 5;
  alert(`Pax Summary:\nTotal Pax: ${totalPax}\nIncluded Pax: ${basePax}\nExtra Pax: ${extraPax}\nAdditional Payment: RM${extraCharge}`);
}

const API_URL = "https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec";

    let unread = JSON.parse(localStorage.getItem("unread") || "[]");
    let lastSeenTime = localStorage.getItem("lastSeenTime") ? new Date(localStorage.getItem("lastSeenTime")) : null;

    function saveState() {
      localStorage.setItem("unread", JSON.stringify(unread));
      if (lastSeenTime) {
        localStorage.setItem("lastSeenTime", lastSeenTime.toISOString());
      }
    }

    function handleBellClick() {
      const badge = document.getElementById("badge");
      if (badge.style.display === "none" || badge.innerText === "0") {
        // No unread ‚Üí go to apAllNoti.html
        window.location.href = "apAllNoti.html";
      } else {
        // Toggle dropdown
        document.getElementById("dropdownNoti").classList.toggle("active");
      }
    }

    async function fetchNotifications() {
      try {
        const res = await fetch(API_URL);
        let data = await res.json();

        // sort newest first
        data.sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

        if (!lastSeenTime && data.length > 0) {
          // first load: set lastSeenTime but do not trigger sound
          lastSeenTime = new Date(data[0].Timestamp);
          saveState();
          return;
        }

        let newOnes = data.filter(n => new Date(n.Timestamp) > lastSeenTime);

        if (newOnes.length > 0) {
          // play sound once for new arrivals
          document.getElementById("dingSound").play().catch(()=>{});
          
          // prepend new ones
          unread = [...newOnes, ...unread];

          // update last seen time to newest
          lastSeenTime = new Date(newOnes[0].Timestamp);

          updateUI();
          saveState();
        }
      } catch(err) {
        console.error("Fetch error", err);
      }
    }

    function updateUI() {
      const badge = document.getElementById("badge");
      const dropdownNoti = document.getElementById("dropdownNoti");

      if (unread.length > 0) {
        badge.innerText = unread.length;
        badge.style.display = "inline";
      } else {
        badge.style.display = "none";
      }

      dropdownNoti.innerHTML = "";
      unread.forEach((n, idx) => {
        const div = document.createElement("div");
        div.className = "notification";
        div.innerHTML = `
          <strong>üîî New Notification</strong>
          <div>"${n.Message}"</div>
          <div>From: ${n.From} | Agent: ${n.Agent}</div>
          <button>See more...</button>
        `;

        // click on card removes it
        div.addEventListener("click", () => {
          unread.splice(idx, 1);
          updateUI();
          saveState();
        });

        // prevent button from removing notification, go to apAllNoti.html
        div.querySelector("button").addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = "apAllNoti.html";
        });

        dropdownNoti.appendChild(div);
      });
    }

    // restore UI from storage on load
    updateUI();

    // initial fetch
    fetchNotifications();
    // poll every 10s
    setInterval(fetchNotifications, 10000);

// Initialize payment methods when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Uncheck all payment method radio buttons
  document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Remove selected class from all payment options
  document.querySelectorAll('.payment-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // Add event listeners to radio buttons
  document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
      selectPaymentMethod(this.value);
    });
  });
  
  // Hide the send invoice button and clear booking IDs
  document.getElementById('sendInvoiceBtn').style.display = 'none';
  localStorage.removeItem('lastCashBookingId');
  localStorage.removeItem('lastQRBookingId'); // Add this line
});
</script>
</body>
</html>


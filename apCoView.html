<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C.O. Camp Booking</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #eef2f7; }
    h2, h3 { margin-top: 0; }
  header {
      background: #ffffff;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      flex-wrap: wrap;
    }
 .logo { font-weight: bold; }

    .menu-toggle {
      display: none;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
    }
nav { display: flex; gap: 1rem; align-items: center; }


.dropdown-btn {
    margin: 0 4px;
    padding: 8px 12px;
    background-color: #f3f4f6;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    width: 150px;
  }
  .dropdown {
    position: relative;
  }
 .dropdown-content {
    display: none;
    position: absolute;
    top: 110%;
    left: 0;
    background-color: white;
    min-width: 100%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 999;
    flex-direction: column;
  }
  .dropdown-content button {
    padding: 10px;
    width: 100%;
    text-align: left;
    background-color: #f3f4f6;
    border: none;
    border-top: 1px solid #ccc;
    border-radius: 0px; /* ‚Üê square buttons */
    white-space: nowrap;      
  }
  .dropdown-content button:hover {
    background-color: white; 
    color: #000; /* optional: make text darker for visibility */
  }
 .dropdown:hover .dropdown-content {
    display: flex;
  }


.tab {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .mobile-menu {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      width: 100%;
    }

    .welcome-mobile {
      display: none;
      font-size: 0.8rem;
      color: #334155;
      margin-left: auto;
      margin-right: 0.5rem;
    }

    main {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
td {
  padding: .75rem;
  border: 1px solid #e2e8f0;
  white-space: nowrap;
}

    h2 { text-align:center; margin-bottom:1rem; }
    .card { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:1000px; margin:1rem auto; }
    .form-group { display:flex; flex-wrap:wrap; margin-bottom:.75rem; gap:1rem; }
    .form-group label { flex:0 0 150px; font-weight:600; }
    .form-group input, .form-group textarea { flex:1; padding:.5rem; border:1px solid #cbd5e1; border-radius:5px; }
    a.btn {
  text-decoration: none;
  display: inline-block;
    }

    .btn { padding:.6rem 1.2rem; border:none; border-radius:5px; cursor:pointer; background:#0ea5e9; color:white; }
    .btn:hover { background:#0284c7; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .table-wrapper { background:white; overflow-x:auto; padding:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:1000px; margin:1rem auto;text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { padding:.75rem; border:1px solid #e2e8f0; }
    th { background:#f1f5f9; }

    @media (max-width: 768px) {
      nav { display: none; }
      .menu-toggle { display: block; }
      .mobile-menu.show { display: flex; }
      .welcome-mobile { display: block; }
      #welcomeText { display: none; }
    }

    @media (max-width: 600px) {
      .form-group label { min-width: 100%; }
    }
  </style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
 <header>
    <div class="logo">üèïÔ∏è Campsite Admin Portal</div>
    <div class="welcome-mobile" id="mobileWelcome"></div>
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <nav>
      <span id="welcomeText" style="margin-right: 1rem; font-weight: bold;"></span>
      <button class="tab" onclick="location.href='adminpage.html'">Dashboard</button>
      <button class="tab" onclick="location.href='apPendingCom.html'">Pending Commissions</button>

      <div class="dropdown">
      <button class="dropdown-btn">Block & Hold ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab" onclick="location.href='apBlockDate.html'">Block Dates</button>
       <button class="tab" onclick="location.href='apHoldUnit.html'">Hold Unit</button>      
      </div>
      </div>

      <div class="dropdown">
      <button class="dropdown-btn">Financials ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab" onclick="location.href='apExpenses.html'">Expense Tracker</button>
       <button class="tab" onclick="location.href='apOtherIncome.html'">Other Income</button>
       <button class="tab" onclick="location.href='apReport.html'">Monthly Report</button>
      </div>
      </div>
      
      <div class="dropdown">
      <button class="dropdown-btn">C.O ‚ñº</button>
      <div class="dropdown-content">
       <button class="tab active">C.O View</button>
       <button class="tab" onclick="location.href='apCoData.html'">C.O Data</button>
      </div>
      </div>

      <button class="tab" onclick="location.href='apCheckAvailability.html'">Check Availability</button>
      <button class="tab" onclick="location.href='apBooking.html'">New Booking</button>
      <button class="tab" onclick="location.href='apAllBooking.html'">All Bookings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
      <button class="tab" onclick="location.href='adminpage.html'">Dashboard</button>
      <button class="tab" onclick="location.href='apPendingCom.html'">Pending Commissions</button>
      <button class="tab" onclick="location.href='apBlockDate.html'">Block Dates</button>
      <button class="tab" onclick="location.href='apHoldUnit.html'">Hold Unit</button>
      <button class="tab" onclick="location.href='apExpenses.html'">Expense Tracker</button>
      <button class="tab" onclick="location.href='apOtherIncome.html'">Other Income</button>
      <button class="tab" onclick="location.href='apReport.html'">Monthly Report</button>
      <button class="tab active">C.O View</button>
      <button class="tab" onclick="location.href='apCoData.html'">C.O Data</button>
      <button class="tab" onclick="location.href='apCheckAvailability.html'">Check Availability</button>
      <button class="tab" onclick="location.href='apBooking.html'">New Booking</button>
      <button class="tab" onclick="location.href='apAllBooking.html'">All Bookings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

<main>
  <h2>Camp Officer ‚Äì Check‚Äëin/Check‚Äëout Panel</h2>

  <!-- Lookup Card -->
<div class="card">
  <div class="form-group">
    <label for="lookupId">Enter Book ID to Load:</label>
    <input type="text" id="lookupId" placeholder="e.g. ABC123" />
    <button type="button" class="btn" onclick="openQRScanner()">üì∑ Scan QR</button>
    <button type="button" class="btn" onclick="lookup()">Lookup</button> 
  </div>
</div>


<!-- QR Scanner Modal -->
<div id="qrModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:#000000cc;z-index:1000;align-items:center;justify-content:center;">
  <div style="background:white;padding:1rem;border-radius:8px;max-width:90%;width:350px;">
    <div id="qr-reader" style="width:100%;"></div>
    <button class="btn" onclick="closeQRScanner()" style="margin-top:1rem;width:100%;">‚ùå Cancel</button>
  </div>
</div>

  <!-- Prefill Form -->
  <div class="card">
<h3 style="margin-top:2rem;">üóÇÔ∏è Bookings Details</h3>
    <div class="form-group"><label>Book ID:</label><input id="bookId" readonly /></div>
    <div class="form-group"><label>Name:</label><input id="custName" readonly /></div>
    <div class="form-group"><label>Contact:</label><input id="custContact" readonly /></div>
    <div class="form-group"><label>Unit:</label><input id="unit" readonly /></div>
    <div class="form-group">
  <label>Check‚Äëin:</label><input id="origCheckin" readonly />
</div>
<div class="form-group">
  <label>Check‚Äëout:</label><input id="origCheckout" readonly />
</div>
<input type="hidden" id="checkinCo" />
<input type="hidden" id="checkoutCo" />
    <div class="form-group"><label>Total Pax:</label><input id="totalPax" readonly /></div>
    <div class="form-group"><label>Extra Pax:</label><input id="extraPax" readonly /></div>
    <div class="form-group"><label>Total Price:</label><input id="totalPrice" readonly /></div>
<br>
    <hr/>

    <!-- CO fields -->
<h3 style="margin-top:2rem;">ü§† C.O Field</h3>
  <div class="form-group">
  <label>Check‚Äëin (CO):</label><input id="checkinCoDisplay" readonly />
  </div>
  <div class="form-group">
  <label>Check‚Äëout (CO):</label><input id="checkoutCoDisplay" readonly />
  </div>
    <div class="form-group">
  <label>Unit Use:</label>
  <select id="unitUse" multiple style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 5px; height: 100px;">
    <option value="">Select Unit</option>
  </select>
</div>

    <div class="form-group"><label>Remark:</label><textarea id="remark" rows="2"></textarea></div>
    
    <div class="form-group">
      <button type="button" class="btn" onclick="setTimestamp('checkinCo')" id="btnCheckin" disabled>Check‚Äëin Now</button>
      <button type="button" class="btn" onclick="setTimestamp('checkoutCo')" id="btnCheckout" disabled>Check‚Äëout Now</button>
    </div>
  </div>

<!-- Need to Check-in -->
<div class="table-wrapper">
  <h3>üì• Need to Check-in Today</h3>
   <h5>‚ö†Ô∏è Alerts if not checked-in by 1PM</h5>
  <table>
    <thead>
      <tr><th>Book ID</th><th>Action</th></tr>
    </thead>
    <tbody id="checkinPendingTable"></tbody>
  </table>
</div>

<!-- Need to Check-out -->
<div class="table-wrapper">
  <h3>üì§ Need to Check-out Today</h3>
   <h5>‚ö†Ô∏è Alerts if not checked-out by 11AM</h5>
  <table>
    <thead>
      <tr><th>Book ID</th><th>Action</th></tr>
    </thead>
    <tbody id="checkoutPendingTable"></tbody>
  </table>
</div>


  <!-- CO data table -->
  <div class="table-wrapper">
    <div style="text-align: left;">
<h3>Today Check-in & Check-out Customer</h3>
     <button class="btn" onclick="refreshTable()">Refresh CO Records</button>
    </div>
    <table>
      <thead>
       <tr>
	<th>Book ID</th><th>Unit</th><th>Unit Use</th><th>Remark</th><th>Check‚Äëin (CO)</th><th>Check‚Äëout (CO)</th><th>C.O</th>
       </tr>
      </thead>
      <tbody id="coTable"></tbody>
    </table>
  </div>

<div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#00000066;z-index:2000;align-items:center;justify-content:center;">
  <div style="background:white;padding:1rem 2rem;border-radius:8px;font-size:1.2rem;font-weight:bold;box-shadow:0 0 10px rgba(0,0,0,0.2);">
    üîÑ Loading...
  </div>
</div>

 </main>
<script>
    const username = localStorage.getItem("username") || "CO";
// üîê Redirect if not logged in (username missing or defaulted to "CO")
if (!localStorage.getItem("username") || localStorage.getItem("username") === "CO") {
  window.location.href = "index.html";
}
    document.getElementById("welcomeText").textContent = `Welcome ${username} !!`;
    document.getElementById("mobileWelcome").textContent = `Welcome ${username} !!`;

function showLoading() {
  document.getElementById("loadingSpinner").style.display = "flex";
}

function hideLoading() {
  document.getElementById("loadingSpinner").style.display = "none";
}


  const DB1_URL = 'https://script.google.com/macros/s/AKfycbwsPIi_Zf7UtwTQJ8BPiLmNR87VxecATUOItw68loKglD60QRcRzeQoqIzyynvTXolipA/exec';
  const DB2_URL = 'https://script.google.com/macros/s/AKfycbxwLq33J4Ud1P7bPVSZM86kr1CUmWeiEAVM9jjB3ffJtiCCfapZEAtVkpzU7v52tmo/exec';

  let db1Data = [], db2Data = [];

async function lookup(){
  const id = document.getElementById('lookupId').value.trim();
  if(!id){ return alert('Enter Book ID.'); }

  showLoading(); // üëà show spinner
  try {
    const [r1, r2] = await Promise.all([ fetch(DB1_URL), fetch(DB2_URL) ]);
    db1Data = (await r1.json()).bookings || [];
    db2Data = await r2.json();

    const rec1 = db1Data.find(o => o.bookId === id);
    const rec2 = db2Data.find(r => r[0] === id);

    if (!rec1) {
      alert('‚ùå Booking not found in database.');
    } else {
      fillForm(rec1, rec2);
    }
  } catch (err) {
    alert("‚ùå Lookup failed. Please try again.");
    console.error(err);
  } finally {
    hideLoading(); // üëà always hide
  }
}

function toggleMenu() {
      document.getElementById("mobileMenu").classList.toggle("show");
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }  

  function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
  }
  
  function formatDateTime(str) {
  if (!str) return '';
  const d = new Date(str);
  if (isNaN(d)) return str;
  return d.toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' }); // Adjust as needed
}

function populateUnitDropdown(checkin, checkout) {
  const unitMap = {
    "A-Tent": ["1A", "2A", "3A", "4A", "5A", "1B", "2B"],
    "Lot A": ["A1"],
    "Lot B": ["B1", "B2", "B3"],
    "Lot C": ["C1", "C2", "C3", "C4", "C5"]
  };

  const unitTypeCount = {};
  const unitUseStr = document.getElementById('unit').value;

  // Parse unit requirements like "A-Tent x1, Lot C x2"
  unitUseStr.split(',').forEach(entry => {
    const match = entry.trim().match(/^(.+?)\s*x(\d+)/i);
    if (match) {
      const type = match[1].trim();
      const count = parseInt(match[2]);
      unitTypeCount[type] = count;
    }
  });

  // Correct overlapping logic using booking database
  const usedUnits = new Set();
  db2Data.forEach(co => {
    const coBookId = co[0];
    const coUnitUse = co[4];
    if (!coBookId || !coUnitUse) return;

    const booking = db1Data.find(b => b.bookId === coBookId);
    if (!booking || !booking.checkin || !booking.checkout) return;

    const bCheckin = parseDateLocal(booking.checkin);
    const bCheckout = parseDateLocal(booking.checkout);

    const overlaps = bCheckin <= checkout && bCheckout > checkin;

    if (overlaps) {
      coUnitUse.split(',').map(x => x.trim()).forEach(u => usedUnits.add(u));
    }
  });

  const dropdown = document.getElementById("unitUse");
  dropdown.innerHTML = ''; // Clear

  // Create optgroups by unit type
  Object.entries(unitTypeCount).forEach(([type, limit]) => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = `${type} (max ${limit})`;

    (unitMap[type] || []).forEach(unit => {
      const option = document.createElement("option");
      option.value = unit;
      option.textContent = unit;
      if (usedUnits.has(unit)) {
        option.disabled = true;
        option.style.color = "gray";
      }
      optgroup.appendChild(option);
    });

    dropdown.appendChild(optgroup);
  });

  // Add selection limiting logic
  dropdown.onchange = () => {
    const selected = Array.from(dropdown.selectedOptions).map(o => o.value);
    const selectedByType = {};

    selected.forEach(unit => {
      for (const [type, units] of Object.entries(unitMap)) {
        if (units.includes(unit)) {
          selectedByType[type] = selectedByType[type] || [];
          selectedByType[type].push(unit);
        }
      }
    });

    // Update enable/disable states
    Array.from(dropdown.options).forEach(option => {
      const optionUnit = option.value;
      const isUsed = usedUnits.has(optionUnit);
      let disable = isUsed;

      for (const [type, units] of Object.entries(unitMap)) {
        if (units.includes(optionUnit) && unitTypeCount[type]) {
          const selectedCount = (selectedByType[type] || []).length;
          if (!selected.includes(optionUnit) && selectedCount >= unitTypeCount[type]) {
            disable = true;
          }
        }
      }

      option.disabled = disable;
      option.style.color = disable ? "gray" : "";
    });
  };
}


function fillForm(d1, d2){
  document.getElementById('bookId').value = d1.bookId;
  document.getElementById('custName').value = d1.name;
  document.getElementById('custContact').value = `${d1.phone} / ${d1.email}`;
  document.getElementById('unit').value = d2 ? d2[1] : '';

  // ‚úÖ Add these two lines to show booking check-in/out
  document.getElementById('origCheckin').value = formatDate(d1.checkin);
  document.getElementById('origCheckout').value = formatDate(d1.checkout);

  document.getElementById('checkinCo').value = d2 ? d2[2] : '';
  document.getElementById('checkoutCo').value = d2 ? d2[3] : '';
  document.getElementById('checkinCoDisplay').value = formatDateTime(d2 ? d2[2] : '');
  document.getElementById('checkoutCoDisplay').value = formatDateTime(d2 ? d2[3] : '');
  document.getElementById('totalPax').value = d1.totalPax;
  document.getElementById('extraPax').value = d1.extraPax;
  document.getElementById('totalPrice').value = d1.total;

// Auto-select previous unitUse if exists (especially for checkout)
const unitUseField = document.getElementById('unitUse');
const existingUnitUse = d2 ? d2[4] : '';
populateUnitDropdown(parseDateLocal(d1.checkin), parseDateLocal(d1.checkout));

// Delay needed to ensure dropdown options are ready before selection
setTimeout(() => {
  if (existingUnitUse) {
    const usedUnits = existingUnitUse.split(',').map(u => u.trim());
    Array.from(unitUseField.options).forEach(opt => {
      if (usedUnits.includes(opt.value)) {
        opt.selected = true;
        opt.disabled = false; // ensure selectable even if marked used
        opt.style.color = ""; // reset style
      }
    });
  }
}, 100);
setTimeout(() => {
  if (existingUnitUse) {
    const usedUnits = existingUnitUse.split(',').map(u => u.trim());
    Array.from(unitUseField.options).forEach(opt => {
      if (usedUnits.includes(opt.value)) {
        opt.selected = true;
        opt.disabled = false; // allow selection just for display
        opt.style.color = ""; // reset style
      }
    });
  }

  // ‚úÖ Disable Unit Use dropdown if already checked in
  const alreadyCheckedIn = !!document.getElementById("checkinCo").value;
  document.getElementById("unitUse").disabled = alreadyCheckedIn;

}, 100);


  document.getElementById('remark').value = d2 ? d2[5] : '';

  document.getElementById('btnCheckin').disabled = false;
  document.getElementById('btnCheckout').disabled = false;
}

function validateUnitUseSelection() {
  const unitMap = {
    "A-Tent": ["1A", "2A", "3A", "4A", "5A", "1B", "2B"],
    "Lot A": ["A1"],
    "Lot B": ["B1", "B2", "B3"],
    "Lot C": ["C1", "C2", "C3", "C4", "C5"]
  };

  const unitUseStr = document.getElementById('unit').value;
  const selected = Array.from(document.getElementById('unitUse').selectedOptions).map(opt => opt.value);

  const unitTypeCount = {};
  unitUseStr.split(',').forEach(entry => {
    const match = entry.trim().match(/^(.+?)\s*x(\d+)/i);
    if (match) {
      const type = match[1].trim();
      const count = parseInt(match[2]);
      unitTypeCount[type] = count;
    }
  });

  const selectedByType = {};
  selected.forEach(unit => {
    for (const [type, list] of Object.entries(unitMap)) {
      if (list.includes(unit)) {
        if (!selectedByType[type]) selectedByType[type] = [];
        selectedByType[type].push(unit);
      }
    }
  });

  for (const [type, requiredCount] of Object.entries(unitTypeCount)) {
    const selectedCount = (selectedByType[type] || []).length;
    if (selectedCount < requiredCount) {
      alert(`‚ö†Ô∏è You selected too few units for ${type}. Required: ${requiredCount}, Selected: ${selectedCount}`);
      return false;
    }
    if (selectedCount > requiredCount) {
      alert(`‚ö†Ô∏è You selected too many units for ${type}. Required: ${requiredCount}, Selected: ${selectedCount}`);
      return false;
    }
  }

  return true;
}

function setTimestamp(field) {
  const now = new Date().toISOString();
  const actionLabel = field === 'checkinCo' ? 'Check-in' : 'Check-out';
  const confirmMsg = `Are you sure you want to mark ${actionLabel.toLowerCase()} now?`;

  const checkinVal = document.getElementById('checkinCo').value;
  const checkoutVal = document.getElementById('checkoutCo').value;
  const unitUseVal = document.getElementById('unitUse').value.trim();

  if (!unitUseVal) {
    return alert('‚ùå Please fill in the "Unit Use" field before proceeding.');
  }

  if (!validateUnitUseSelection()) {
  return; // üö´ prevent submission if invalid
  }

  if (field === 'checkinCo' && checkinVal) {
    return alert('‚ö†Ô∏è Already checked in!');
  }

  if (field === 'checkoutCo') {
    if (!checkinVal) {
      return alert('‚ùå Cannot check out before check-in.');
    }
    if (checkoutVal) {
      return alert('‚ö†Ô∏è Already checked out!');
    }
  }

  if (!confirm(confirmMsg)) return;

  // Only update the clicked field
  if (field === 'checkinCo') {
    document.getElementById('checkinCo').value = now;
  } else {
    document.getElementById('checkoutCo').value = now;
  }

  submitDB2(); // Will send both checkinCo and checkoutCo, using whatever values are in the inputs
}

async function submitDB2() {
  const payload = new URLSearchParams();
  payload.append("action", "coUpdate");
  payload.append("bookId", document.getElementById('bookId').value);
  const selectedUnits = Array.from(document.getElementById('unitUse').selectedOptions).map(opt => opt.value).join(', ');
payload.append("unitUse", selectedUnits);

  payload.append("remark", document.getElementById('remark').value);
  payload.append("checkinCo", document.getElementById('checkinCo').value);
  payload.append("checkoutCo", document.getElementById('checkoutCo').value);
  payload.append("coName", username); // üëà This line adds the logged-in user's name

  try {
    const res = await fetch(DB2_URL, {
      method: 'POST',
      body: payload
    });
    const txt = await res.text();
    console.log("‚úÖ Response from DB2:", txt);
    alert("‚úÖ CO data saved.");
    setTimeout(() => location.reload(), 800); // reload after 0.8s
  } catch (err) {
    console.error("‚ùå Failed to update CO data:", err);
    alert("‚ùå Failed to update CO database.");
  }
}

function parseDateLocal(dateString) {
  if (!dateString) return null;
  if (dateString.includes('/')) {
    // Format: DD/MM/YYYY
    const parts = dateString.split('/');
    if (parts.length === 3) {
      return new Date(+parts[2], parts[1] - 1, +parts[0]); // Local date
    }
  } else if (dateString.includes('T')) {
    // ISO datetime: strip timezone
    const d = new Date(dateString);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  } else if (dateString.includes('-')) {
    // ISO date: YYYY-MM-DD
    const parts = dateString.split('-');
    if (parts.length === 3) {
      return new Date(+parts[0], parts[1] - 1, +parts[2]);
    }
  }
  return new Date(dateString); // fallback
}

function formatDateOnly(d) {
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

async function refreshTable() {
  const [res1, res2] = await Promise.all([fetch(DB1_URL), fetch(DB2_URL)]);
  db1Data = (await res1.json()).bookings || [];
  db2Data = await res2.json();

  const tb = document.getElementById('coTable');
  tb.innerHTML = '';

  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  db1Data.forEach(book => {
    const bookId = book.bookId;
    if (bookId.startsWith("HOLD") || bookId.startsWith("BLOCK")) return;

    const checkinDate = parseDateLocal(book.checkin);
    const checkoutDate = parseDateLocal(book.checkout);

    const checkinMatch = checkinDate && formatDateOnly(checkinDate) === todayStr;
    const checkoutMatch = checkoutDate && formatDateOnly(checkoutDate) === todayStr;

    if (checkinMatch || checkoutMatch) {
      const match = db2Data.find(r => r[0] === bookId);
      tb.innerHTML += `<tr>
        <td>${bookId}</td>
        <td>${match ? match[1] : ''}</td>
        <td>${match ? match[4] : ''}</td>
        <td>${match ? match[5] : ''}</td>
        <td>${formatDateTime(match ? match[2] : '')}</td>
        <td>${formatDateTime(match ? match[3] : '')}</td>
        <td>${match ? (match[6] || '') : ''}</td>
      </tr>`;
    }
  });

  // Keep your existing alert + pending check-in/out logic
  const hourNow = today.getHours();
  const checkinPendingTB = document.getElementById('checkinPendingTable');
  const checkoutPendingTB = document.getElementById('checkoutPendingTable');
  checkinPendingTB.innerHTML = '';
  checkoutPendingTB.innerHTML = '';

  db1Data.forEach(book => {
    const bookId = book.bookId;
    const phone = book.phone;
    if (bookId.startsWith("HOLD") || bookId.startsWith("BLOCK")) return;

    const checkinDate = parseDateLocal(book.checkin);
    const checkoutDate = parseDateLocal(book.checkout);
    const matching = db2Data.find(r => r[0] === bookId);

    if (checkinDate && formatDateOnly(checkinDate) === todayStr && (!matching || !matching[2])) {
checkinPendingTB.innerHTML += `
  <tr>
    <td>${bookId}</td>
    <td>
      <a class="btn" href="tel:${phone}">üìû Call </a>
      <a class="btn" target="_blank" href="https://wa.me/${String(phone).replace(/\D/g, '')}?text=${encodeURIComponent("Hi! I'm from MK RIMBA CAMP, as we check in our database you not checkin yet.")}">üí¨ Whatsapp</a>
    </td>
  </tr>`;

    }

    if (checkoutDate && formatDateOnly(checkoutDate) === todayStr && (!matching || !matching[3])) {
checkoutPendingTB.innerHTML += `
  <tr>
    <td>${bookId}</td>
    <td>
      <a class="btn" href="tel:${phone}">üìû Call </a>
      <a class="btn" target="_blank" href="https://wa.me/${String(phone).replace(/\D/g, '')}?text=${encodeURIComponent("Hi! I'm from MK RIMBA CAMP, as we check in our database you not checkout yet.")}">üí¨ Whatsapp</a>
    </td>
  </tr>`;

    }

    if (checkinDate && formatDateOnly(checkinDate) === todayStr && hourNow >= 13) {
      if (!matching || !matching[2]) {
        alert(`‚ö†Ô∏è Booking [${bookId}] has not been checked in by CO. Please follow up.`);
      }
    }

    if (checkoutDate && formatDateOnly(checkoutDate) === todayStr && hourNow >= 11) {
      if (!matching || !matching[3]) {
        alert(`‚ö†Ô∏è Booking [${bookId}] has not been checked out by CO. Please follow up.`);
      }
    }
  });
}


let html5QrCode;

function openQRScanner() {
  document.getElementById("qrModal").style.display = "flex";
  html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    qrCodeMessage => {
      document.getElementById("lookupId").value = qrCodeMessage;
      closeQRScanner();
      lookup(); // auto trigger lookup
    },
    errorMessage => {
      // silently ignore scan errors
    }
  ).catch(err => {
    alert("Camera start failed: " + err);
    closeQRScanner();
  });
}

function closeQRScanner() {
  document.getElementById("qrModal").style.display = "none";
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
    }).catch(err => {
      console.error("Failed to stop QR scanner", err);
    });
  }
}

  window.onload = refreshTable;
</script>
</body>
</html>
